@using DSLKIT.Visualizer.Abstractions

<section class="card h-100 dsl-input-panel">
    <div class="card-header">Input</div>
    <div class="card-body d-flex flex-column">
        <div class="mb-3">
            <label class="form-label" for="grammar-example-select">Example</label>
            @if (SelectedProvider == null)
            {
                <div class="text-muted">Select a grammar to load examples.</div>
            }
            else if (SelectedProvider.Examples.Count == 0)
            {
                <div class="text-muted">This grammar does not provide built-in examples.</div>
            }
            else
            {
                <select id="grammar-example-select"
                        class="form-select"
                        @key="@($"{SelectedProvider.Id}:{effectiveSelectedExampleId}")"
                        value="@effectiveSelectedExampleId"
                        @onchange="OnSelectedExampleChangedAsync">
                    @foreach (var example in SelectedProvider.Examples)
                    {
                        <option value="@example.Id" selected="@(string.Equals(example.Id, effectiveSelectedExampleId, StringComparison.Ordinal))">
                            @example.Name
                        </option>
                    }
                </select>

                @if (selectedExample != null)
                {
                    <div class="form-text">@selectedExample.Description</div>
                }
            }
        </div>

        <div class="dsl-input-editor-wrap">
            <div class="dsl-input-toolbar mb-1">
                <label class="form-label mb-0" for="@SourceInputId">Source Text</label>
                <button class="btn btn-primary btn-sm d-flex align-items-center gap-2"
                        @onclick="OnParseRequestedAsync"
                        disabled="@IsParseDisabled"
                        title="Parse (Ctrl+Enter)">
                    @if (IsParsing)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span>Parsing...</span>
                    }
                    else
                    {
                        <span>Parse</span>
                    }
                </button>
            </div>

            <textarea id="@SourceInputId"
                      class="form-control dsl-source-editor"
                      rows="18"
                      spellcheck="false"
                      value="@SourceText"
                      @oninput="OnSourceTextChangedAsync"
                      @onkeydown="OnSourceInputKeyDownAsync"></textarea>

            <div class="@InputStatusClass">@InputStatusText</div>
        </div>
    </div>
</section>

@code {
    private string? effectiveSelectedExampleId =>
        !string.IsNullOrWhiteSpace(SelectedExampleId)
            ? SelectedExampleId
            : SelectedProvider?.Examples.FirstOrDefault()?.Id;

    private DslGrammarExample? selectedExample =>
        SelectedProvider?.Examples.FirstOrDefault(example => example.Id == effectiveSelectedExampleId);

    [Parameter]
    public IDslGrammarProvider? SelectedProvider { get; set; }

    [Parameter]
    public string? SelectedExampleId { get; set; }

    [Parameter]
    public string SourceText { get; set; } = string.Empty;

    [Parameter]
    public bool IsParsing { get; set; }

    [Parameter]
    public bool IsParseDisabled { get; set; }

    [Parameter]
    public string InputStatusClass { get; set; } = string.Empty;

    [Parameter]
    public string InputStatusText { get; set; } = string.Empty;

    [Parameter]
    public string SourceInputId { get; set; } = "source-input";

    [Parameter]
    public EventCallback<ChangeEventArgs> SelectedExampleChanged { get; set; }

    [Parameter]
    public EventCallback<string> SourceTextChanged { get; set; }

    [Parameter]
    public EventCallback<KeyboardEventArgs> SourceInputKeyDown { get; set; }

    [Parameter]
    public EventCallback ParseRequested { get; set; }

    private Task OnSelectedExampleChangedAsync(ChangeEventArgs args)
    {
        if (!SelectedExampleChanged.HasDelegate)
        {
            return Task.CompletedTask;
        }

        return SelectedExampleChanged.InvokeAsync(args);
    }

    private Task OnSourceTextChangedAsync(ChangeEventArgs args)
    {
        if (!SourceTextChanged.HasDelegate)
        {
            return Task.CompletedTask;
        }

        var nextText = args.Value?.ToString() ?? string.Empty;
        return SourceTextChanged.InvokeAsync(nextText);
    }

    private Task OnSourceInputKeyDownAsync(KeyboardEventArgs args)
    {
        if (!SourceInputKeyDown.HasDelegate)
        {
            return Task.CompletedTask;
        }

        return SourceInputKeyDown.InvokeAsync(args);
    }

    private Task OnParseRequestedAsync()
    {
        if (!ParseRequested.HasDelegate)
        {
            return Task.CompletedTask;
        }

        return ParseRequested.InvokeAsync();
    }
}
