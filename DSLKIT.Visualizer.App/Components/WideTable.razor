@using DSLKIT.Visualizer.App.Visualization

<MudPaper Class="pa-3" Elevation="0">
    <div class="@containerClass">
        <MudTable T="WideTableRow"
                  Items="rows"
                  Dense="true"
                  Hover="true"
                  Bordered="true"
                  Striped="true"
                  Breakpoint="Breakpoint.None"
                  Class="dsl-wide-table">
            <ToolBarContent>
                <MudText Typo="Typo.caption" Class="text-muted">
                    columns: @Table.Columns.Count, rows: @Table.Rows.Count
                </MudText>
                <MudSpacer />
                <MudMenu Dense="true" Icon="@Icons.Material.Filled.Tune">
                    <MudStack Class="pa-2" Spacing="1">
                        <MudCheckBox T="bool" @bind-Value="ShowVerticalHeaders" Dense="true" Label="Vertical headers" />
                        <MudCheckBox T="bool" @bind-Value="WrapCells" Dense="true" Label="Wrap cells" />
                    </MudStack>
                </MudMenu>
            </ToolBarContent>
            <HeaderContent>
                @for (var columnIndex = 0; columnIndex < visibleColumnCount; columnIndex++)
                {
                    var headerColumnIndex = columnIndex;
                    <MudTh Class="dsl-wide-table-header">
                        <span>@columnNames[headerColumnIndex]</span>
                    </MudTh>
                }
            </HeaderContent>
            <RowTemplate>
                @for (var columnIndex = 0; columnIndex < visibleColumnCount; columnIndex++)
                {
                    var cellColumnIndex = columnIndex;
                    var cellValue = ResolveCellValue(context.Cells, cellColumnIndex);
                    <MudTd Class="dsl-wide-table-cell" title="@cellValue">
                        @cellValue
                    </MudTd>
                }
            </RowTemplate>
        </MudTable>
    </div>
</MudPaper>

@code {
    private const string BaseContainerClass = "dsl-wide-table-container";

    private bool showVerticalHeaders;
    private bool wrapCells;
    private int visibleColumnCount;
    private string containerClass = BaseContainerClass;
    private string[] columnNames = [];
    private IReadOnlyList<WideTableRow> rows = [];

    [Parameter]
    public required TableDto Table { get; set; }

    private bool ShowVerticalHeaders
    {
        get => showVerticalHeaders;
        set
        {
            if (showVerticalHeaders == value) return;
            showVerticalHeaders = value;
            UpdateContainerClass();
        }
    }

    private bool WrapCells
    {
        get => wrapCells;
        set
        {
            if (wrapCells == value) return;
            wrapCells = value;
            UpdateContainerClass();
        }
    }

    protected override void OnParametersSet()
    {
        var maxRowCellCount = Table.Rows.Count == 0
            ? 0
            : Table.Rows.Max(row => row.Count);

        visibleColumnCount = Math.Max(Table.Columns.Count, maxRowCellCount);
        columnNames = Enumerable.Range(0, visibleColumnCount)
            .Select(ResolveColumnName)
            .ToArray();

        rows = Table.Rows
            .Select(cells => new WideTableRow(cells))
            .ToList();

        UpdateContainerClass();
    }

    private string ResolveColumnName(int columnIndex)
    {
        return columnIndex < Table.Columns.Count
            ? Table.Columns[columnIndex]
            : $"Column {columnIndex + 1}";
    }

    private void UpdateContainerClass()
    {
        var classNames = new List<string> { BaseContainerClass };
        if (showVerticalHeaders)
            classNames.Add("dsl-wide-table-container-vertical-headers");
        if (wrapCells)
            classNames.Add("dsl-wide-table-container-wrap-cells");

        containerClass = string.Join(" ", classNames);
    }

    private static string ResolveCellValue(IReadOnlyList<string> row, int columnIndex)
        => columnIndex < row.Count ? row[columnIndex] : string.Empty;

    private sealed record WideTableRow(IReadOnlyList<string> Cells);
}
