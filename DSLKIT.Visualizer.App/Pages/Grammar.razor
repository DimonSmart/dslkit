@page "/grammar"
@inject IGrammarProviderCatalog ProviderCatalog
@inject IGrammarSnapshotMapper SnapshotMapper

<PageTitle>Grammar</PageTitle>

<MudText Typo="Typo.h4">Grammar</MudText>

<ProviderManager SelectedProviderId="selectedProviderId"
                 SelectedProviderIdChanged="OnSelectedProviderChangedAsync"
                 SelectElementId="grammar-provider-select" />

<MudButton Variant="Variant.Filled"
           Color="Color.Primary"
           OnClick="LoadGrammar"
           Disabled="@string.IsNullOrWhiteSpace(selectedProviderId)">
    Load Grammar
</MudButton>

@if (!string.IsNullOrWhiteSpace(loadErrorMessage))
{
    <MudAlert Severity="Severity.Error" Class="mt-3">
        @loadErrorMessage
    </MudAlert>
}

@if (snapshot != null)
{
    <MudPaper Class="mt-4 pa-4 dsl-summary-paper" Elevation="1">
        <MudText Typo="Typo.h6">@snapshot.GrammarName</MudText>

        <dl class="row mb-0 mt-3">
            <dt class="col-sm-3">Root</dt>
            <dd class="col-sm-9">@snapshot.RootName</dd>
            <dt class="col-sm-3">Terminals</dt>
            <dd class="col-sm-9">@snapshot.TerminalCount</dd>
            <dt class="col-sm-3">Non-terminals</dt>
            <dd class="col-sm-9">@snapshot.NonTerminalCount</dd>
            <dt class="col-sm-3">Productions</dt>
            <dd class="col-sm-9">@snapshot.Productions.Count</dd>
            <dt class="col-sm-3">Rule sets</dt>
            <dd class="col-sm-9">@snapshot.RuleSetCount</dd>
        </dl>
    </MudPaper>

    <MudExpansionPanels Class="mt-4" MultiExpansion="true">
        <MudExpansionPanel Text="Productions" Expanded="true">
            <div class="dsl-wide-table-container">
                <MudTable T="ProductionRowDto"
                          Items="snapshot.Productions"
                          Dense="true"
                          Hover="true"
                          Bordered="true"
                          Striped="true"
                          Breakpoint="Breakpoint.None"
                          Class="dsl-wide-table">
                    <HeaderContent>
                        <MudTh>#</MudTh>
                        <MudTh>Left</MudTh>
                        <MudTh>Right</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="#">@context.Number</MudTd>
                        <MudTd DataLabel="Left">@context.Left</MudTd>
                        <MudTd DataLabel="Right">@context.Right</MudTd>
                    </RowTemplate>
                </MudTable>
            </div>
        </MudExpansionPanel>

        <MudExpansionPanel Text="@snapshot.TranslationTable.Name">
            <WideTable Table="snapshot.TranslationTable" />
        </MudExpansionPanel>

        <MudExpansionPanel Text="@snapshot.ActionAndGotoTable.Name">
            <WideTable Table="snapshot.ActionAndGotoTable" />
        </MudExpansionPanel>

        <MudExpansionPanel Text="@snapshot.FirstsTable.Name">
            <WideTable Table="snapshot.FirstsTable" />
        </MudExpansionPanel>

        <MudExpansionPanel Text="@snapshot.FollowsTable.Name">
            <WideTable Table="snapshot.FollowsTable" />
        </MudExpansionPanel>
    </MudExpansionPanels>
}

@code {
    private string? selectedProviderId;
    private GrammarSnapshotDto? snapshot;
    private string? loadErrorMessage;

    private void LoadGrammar()
    {
        snapshot = null;
        loadErrorMessage = null;

        if (string.IsNullOrWhiteSpace(selectedProviderId))
        {
            loadErrorMessage = "Select a grammar provider.";
            return;
        }

        var provider = ProviderCatalog.FindById(selectedProviderId);
        if (provider == null)
        {
            loadErrorMessage = $"Provider '{selectedProviderId}' is not registered.";
            return;
        }

        try
        {
            var grammar = provider.BuildGrammar();
            snapshot = SnapshotMapper.Map(grammar);
        }
        catch (Exception ex)
        {
            loadErrorMessage = $"Failed to load grammar: {ex.Message}";
        }
    }

    private Task OnSelectedProviderChangedAsync(string? providerId)
    {
        selectedProviderId = providerId;
        snapshot = null;
        loadErrorMessage = null;
        return Task.CompletedTask;
    }
}
